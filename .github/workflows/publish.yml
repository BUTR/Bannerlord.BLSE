name: Publish

on:
  push:
    paths:
      - '.github/workflows/publish.yml'
      - 'src/Bannerlord.LauncherEx/**.*'
      - 'src/Bannerlord.BLSE/**.*'
      - 'src/Bannerlord.BLSE.Shared/**.*'
      - 'src/Bannerlord.BLSE.Standalone/**.*'
      - 'src/Bannerlord.BLSE.Launcher/**.*'
      - 'src/Bannerlord.BLSE.LauncherEx/**.*'
  workflow_dispatch:

env:
  # Disable the .NET logo in the console output.
  DOTNET_NOLOGO: true
  # Disable the .NET first time experience to skip caching NuGet packages and speed up the build.
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  # Disable sending .NET CLI telemetry to Microsoft.
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    name: Publish
    runs-on: ubuntu-latest
    outputs:
      mod_version: ${{ steps.changelog.outputs.mod_version }}
      mod_description: ${{ steps.changelog.outputs.mod_description }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        uses: butr/actions-common-setup@v2
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}

      - name: Build Bannerlord.BLSE
        run: |
          mkdir bannerlord;
          dotnet build src/Bannerlord.BLSE.Shared/Bannerlord.BLSE.Shared.csproj --configuration Release -p:GameFolder="$PWD/bannerlord" /nowarn:MSB4011;
          dotnet build src/Bannerlord.BLSE.Standalone/Bannerlord.BLSE.Standalone.csproj --configuration Release -p:GameFolder="$PWD/bannerlord" /nowarn:MSB4011;
          dotnet build src/Bannerlord.BLSE.Launcher/Bannerlord.BLSE.Launcher.csproj --configuration Release -p:GameFolder="$PWD/bannerlord" /nowarn:MSB4011;
          dotnet build src/Bannerlord.BLSE.LauncherEx/Bannerlord.BLSE.LauncherEx.csproj --configuration Release -p:GameFolder="$PWD/bannerlord" /nowarn:MSB4011;
        shell: pwsh

      - name: Install and Run ChangelogParser
        id: changelog
        run: |
          dotnet tool install -g Bannerlord.ChangelogParser

          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)

          echo "mod_version=$(bannerlord_changelog_parser latestversion -f "$PWD/changelog.txt")" >> $GITHUB_OUTPUT

          echo "mod_description<<$EOF" >> $GITHUB_ENV
          bannerlord_changelog_parser fulldescription -f "$PWD/changelog.txt" >> $GITHUB_ENV
          echo "$EOF" >> $GITHUB_ENV
        shell: bash
        
      - name: Upload Bannerlord folder
        uses: actions/upload-artifact@v3
        with:
          name: bannerlord
          path: ./bannerlord/
  
  ###########################
  #        NEXUSMODS        #
  ###########################
  publish-on-nexusmods:
    if: false && github.ref == 'refs/heads/master'
    needs: ["build"]
    uses: BUTR/workflows/.github/workflows/release-nexusmods.yml@master
    with:
      nexusmods_game_id: mountandblade2bannerlord
      nexusmods_mod_id: 1
      mod_filename: BLSE
      mod_version: ${{ needs.build.outputs.mod_version }}
      mod_description: ${{ needs.build.outputs.mod_description }}
      artifact_name: bannerlord
    secrets:
      NEXUSMODS_APIKEY: ${{ secrets.NEXUSMODS_APIKEY }}
      NEXUSMODS_COOKIES: ${{ secrets.NEXUSMODS_COOKIES }}

  ###########################
  #         GITHUB          #
  ###########################
  publish-on-github:
    if: github.ref == 'refs/heads/master'
    needs: ["build"]
    uses: BUTR/workflows/.github/workflows/release-github.yml@master
    with:
      mod_id: Bannerlord.BLSE
      mod_version: ${{ needs.build.outputs.mod_version }}
      mod_description: ${{ needs.build.outputs.mod_description }}
      artifact_name: bannerlord
